import { expect } from 'chai';
import {
  BalancerError,
  BalancerErrorCode,
  BalancerSdkConfig,
  Network,
  Pool,
  StaticPoolRepository,
} from '@/.';
import { PoolsProvider } from '@/modules/pools/provider';

import pools_14717479 from '@/test/lib/pools_14717479.json';
import { parseFixed } from '@/lib/utils/math';

const dai_usdc_usdt_pool_id =
  '0x06df3b2bbb68adc8b0e302443692037ed9f91b42000000000000000000000063'; // Balancer USD Stable Pool - staBAL3

const exiter = '0x35f5a330FD2F8e521ebd259FA272bA8069590741';
const slippage = '100'; // 100 bps

describe('exit module', async () => {
  const sdkConfig: BalancerSdkConfig = {
    network: Network.MAINNET,
    rpcUrl: ``,
  };
  const pools = new PoolsProvider(
    sdkConfig,
    new StaticPoolRepository(pools_14717479 as Pool[])
  );
  const pool = await pools.find(dai_usdc_usdt_pool_id);
  if (!pool) throw new BalancerError(BalancerErrorCode.POOL_DOESNT_EXIST);

  describe('buildExitExactBPTIn', () => {
    const bptIn = parseFixed('100', 18).toString(); // bpt in EVM amounts
    context('proportional amounts out', () => {
      it('should return encoded params', async () => {
        const { data } = pool.buildExitExactBPTIn(exiter, bptIn, slippage);

        expect(data).to.equal(
          '0x8bdb391306df3b2bbb68adc8b0e302443692037ed9f91b4200000000000000000000006300000000000000000000000035f5a330fd2f8e521ebd259fa272ba806959074100000000000000000000000035f5a330fd2f8e521ebd259fa272ba80695907410000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000001cd70c57f08a1d48f0000000000000000000000000000000000000000000000000000000001ef82990000000000000000000000000000000000000000000000000000000002047879000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000056bc75e2d63100000'
        );
      });
    });
    context('single token max out', () => {
      it('should return encoded params', async () => {
        const { data } = pool.buildExitExactBPTIn(
          exiter,
          bptIn,
          slippage,
          pool.tokensList[0]
        );

        expect(data).to.equal(
          '0x8bdb391306df3b2bbb68adc8b0e302443692037ed9f91b4200000000000000000000006300000000000000000000000035f5a330fd2f8e521ebd259fa272ba806959074100000000000000000000000035f5a330fd2f8e521ebd259fa272ba80695907410000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000003a432d1bf1a20356300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000056bc75e2d631000000000000000000000000000000000000000000000000000000000000000000000'
        );
      });
    });
  });
  describe('buildExitExactTokensOut', () => {
    const tokensOut = pool.tokensList;
    const amountsOut = pool.tokens.map((t) =>
      parseFixed(t.balance, t.decimals).div('100000').toString()
    ); // EVM amounts)
    it('should return encoded params', async () => {
      const { data } = await pool.buildExitExactTokensOut(
        exiter,
        tokensOut,
        amountsOut,
        slippage
      );

      expect(data).to.equal(
        '0x8bdb391306df3b2bbb68adc8b0e302443692037ed9f91b4200000000000000000000006300000000000000000000000035f5a330fd2f8e521ebd259fa272ba806959074100000000000000000000000035f5a330fd2f8e521ebd259fa272ba80695907410000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000030000000000000000000000006b175474e89094c44da98b954eedeac495271d0f000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000022253457fb06e3bf280000000000000000000000000000000000000000000000000000000024aa9879000000000000000000000000000000000000000000000000000000002637a7d900000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000022253457fb06e3bf280000000000000000000000000000000000000000000000000000000024aa9879000000000000000000000000000000000000000000000000000000002637a7d9'
      );
    });
  });
});
